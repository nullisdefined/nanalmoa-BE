name: CI/CD

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - run: npm ci
    - run: npm run build --if-present
    - run: npm test

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - uses: actions/checkout@v4
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          DEPLOY_DIR="/var/www/nestjs-app/nanalmoa-BE"
          BACKUP_DIR="/var/www/nestjs-app/nanalmoa-BE_backup_$(date +%Y%m%d%H%M%S)"

          echo "=== System Information ==="
          uname -a
          df -h
          free -m

          echo "=== Git Version ==="
          git --version

          echo "=== Cleaning up disk space ==="
          sudo apt clean
          sudo journalctl --vacuum-time=3d
          sudo rm -rf /tmp/*

          echo "=== Network Connectivity Test ==="
          ping -c 4 github.com
          curl -I https://github.com

          echo "=== Configuring Git ==="
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 300
          git config --global http.postBuffer 524288000

          echo "=== Backing up existing directory ==="
          if [ -d "$DEPLOY_DIR" ]; then
            sudo mv "$DEPLOY_DIR" "$BACKUP_DIR"
          fi

          echo "=== Creating new directory ==="
          sudo mkdir -p "$DEPLOY_DIR"
          sudo chown -R $USER:$USER "$DEPLOY_DIR"

          echo "=== Cloning Repository ==="
          if ! GIT_TRACE=1 git clone --verbose --depth 1 --single-branch https://github.com/nullisdefined/nanalmoa-BE.git "$DEPLOY_DIR" 2>&1 | tee /tmp/git_clone_output.log; then
            echo "Git clone failed. Error message:"
            cat /tmp/git_clone_output.log
            exit 1
          fi

          cd "$DEPLOY_DIR"

          echo "=== Git Configuration ==="
          git config --list

          echo "=== Clearing npm cache ==="
          npm cache clean --force

          echo "=== Installing dependencies ==="
          if ! npm install 2>&1 | tee /tmp/npm_install_output.log; then
            echo "npm install failed. Error message:"
            cat /tmp/npm_install_output.log
            exit 1
          fi

          echo "=== Building the application ==="
          if ! npm run build 2>&1 | tee /tmp/npm_build_output.log; then
            echo "npm build failed. Error message:"
            cat /tmp/npm_build_output.log
            exit 1
          fi

          echo "=== Setting up environment variables ==="
          sudo grep -v '^#' /etc/environment | sed 's/"\([^"]*\)"/\1/g' | sudo tee .production.env > /dev/null
          sudo chown $USER:$USER .production.env
          sudo chmod 600 .production.env

          echo "=== Managing PM2 process ==="
          if pm2 list | grep -q "nanalmoa"; then
            pm2 delete nanalmoa
          fi
          if ! pm2 start dist/main.js --name nanalmoa --env production; then
            echo "Failed to start PM2 process"
            exit 1
          fi

          echo "=== Saving PM2 process list ==="
          pm2 save

          echo "=== Cleaning up backup ==="
          if [ -d "$BACKUP_DIR" ]; then
            sudo rm -rf "$BACKUP_DIR"
          fi

          echo "=== Deployment completed successfully ==="
        timeout: 30m